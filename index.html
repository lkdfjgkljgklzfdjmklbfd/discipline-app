<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <title>DISCIPLINE</title>

  <style>
    :root{
      --red:#ff1a1a;
      --red2:#b30000;
      --panel: rgba(10,10,10,0.92);
      --panel2: rgba(18,18,18,0.92);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#000;
      color:var(--text);
      overflow:hidden;
    }

    canvas{
      position:fixed;
      inset:0;
      width:100vw;
      height:100vh;
      z-index:-2;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      background: radial-gradient(ellipse at center, rgba(0,0,0,0.25), rgba(0,0,0,0.82));
      z-index:-1;
    }

    #container{
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }

    .card{
      width:min(820px, 100%);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid rgba(255,26,26,0.14);
      border-radius:24px;
      box-shadow: 0 25px 60px rgba(0,0,0,0.75),
        0 0 0 1px rgba(255,26,26,0.18),
        inset 0 1px 0 rgba(255,255,255,0.04),
        inset 0 -30px 80px rgba(0,0,0,0.35);
      padding:28px;
      transform: translateZ(0);
    }

    #intro h1{
      font-size: clamp(42px, 7vw, 66px);
      font-weight: 900;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      margin: 0;
      line-height: 1;
      color: var(--red);
      text-shadow:
        0 0 8px rgba(255,0,0,0.35),
        0 0 20px rgba(255,0,0,0.18);
    }
    #intro h2{
      margin-top: 12px;
      font-size: 12px;
      letter-spacing: 0.35em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.65);
      font-weight: 700;
    }

    .terminal-line{
      width: min(360px, 85%);
      height: 2px;
      margin: 16px auto 10px;
      background: linear-gradient(90deg, transparent, rgba(255,0,0,0.95), transparent);
      box-shadow: 0 0 14px rgba(255,0,0,0.4);
    }

    #mode{
      font-size:22px;
      margin:6px 0 12px;
      letter-spacing:0.5px;
    }

    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      background: linear-gradient(180deg, var(--red2), #7a0000);
      color:white;
      font-weight:900;
      letter-spacing:1px;
      border-radius:16px;
      height:54px;
      padding:0 18px;
      min-width: 220px;
      box-shadow: 0 10px 26px rgba(255,0,0,0.18);
      transition: transform .08s ease, filter .15s ease;
    }
    .btn:hover{ filter:brightness(1.08); }
    .btn:active{ transform: scale(0.98); }
    .card .btn{ margin:10px 8px 0; }

    .choice{
      font-weight: 600;
      letter-spacing: 0.2px;
      color: rgba(255,255,255,0.90);
      background: rgba(28,28,28,0.92);
      border: 1px solid rgba(255,26,26,0.20);
      border-radius: 20px;
      padding: 18px 16px;
      margin: 12px 0;
      cursor: pointer;
      font-size: 19px;
      line-height: 1.35;
      text-align: left;
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    }
    .choice.selected{
      border-color: rgba(255,26,26,0.90);
      box-shadow: 0 0 0 2px rgba(255,26,26,0.28), 0 12px 34px rgba(0,0,0,0.5);
    }

    .word-container{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:10px;
      margin:16px 0;
      min-height:64px;
      padding:10px;
      border-radius:16px;
      background: rgba(28,28,28,0.75);
      border:1px solid rgba(255,255,255,0.10);
    }
    .word{
      background: rgba(255,26,26,0.18);
      border:1px solid rgba(255,26,26,0.28);
      padding:10px 14px;
      border-radius:16px;
      font-size:18px;
      font-weight:900;
      user-select:none;
      cursor:pointer;
    }

    #result{
      margin-top:14px;
      font-size:18px;
      font-weight:900;
      letter-spacing:0.5px;
    }

    .hint{
      margin-top:12px;
      color:var(--muted);
      font-size:13px;
    }

    #streakBox{
      position:fixed;
      top: calc(env(safe-area-inset-top) + 12px);
      right: 12px;
      font-size:13px;
      color:rgba(255,255,255,0.85);
      z-index:99999;
      pointer-events:none;
    }

    #credit{
      position:fixed;
      bottom: calc(env(safe-area-inset-bottom) + 12px);
      right:12px;
      font-size:12px;
      color:rgba(255,255,255,0.55);
      letter-spacing:1px;
      z-index:9999;
      pointer-events:none;
    }

    #toast{
      position: fixed;
      left: 50%;
      top: calc(env(safe-area-inset-top) + 20px);
      transform: translateX(-50%);
      z-index: 999999;
      pointer-events: none;
      opacity: 0;
    }
    .toast-inner{
      display:flex;
      align-items:center;
      gap:10px;
      background: rgba(20,20,20,0.92);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 999px;
      padding: 10px 14px;
      box-shadow: 0 16px 50px rgba(0,0,0,0.55);
      font-weight: 900;
      letter-spacing: 0.6px;
    }
    .toast-inner.good{ border-color: rgba(255,26,26,0.45); }
    .toast-inner.bad{ border-color: rgba(255,255,255,0.12); opacity: 0.95; }
    .toast-show{ animation: toastInOut 1.0s ease forwards; }
    @keyframes toastInOut{
      0%{ opacity:0; transform: translateX(-50%) translateY(-8px) scale(0.96); }
      15%{ opacity:1; transform: translateX(-50%) translateY(0px) scale(1); }
      80%{ opacity:1; transform: translateX(-50%) translateY(0px) scale(1); }
      100%{ opacity:0; transform: translateX(-50%) translateY(-10px) scale(0.98); }
    }

    #rankUpOverlay{
      position: fixed;
      inset: 0;
      z-index: 999998;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      background: rgba(0,0,0,0.78);
      backdrop-filter: blur(8px);
    }
    .rankup-card{
      width: min(520px, 100%);
      border-radius: 24px;
      padding: 22px;
      background: linear-gradient(180deg, rgba(16,16,16,0.96), rgba(8,8,8,0.96));
      border: 1px solid rgba(255,26,26,0.20);
      box-shadow: 0 22px 80px rgba(255,0,0,0.14);
      text-align: center;
    }
    .rankup-badge{
      width: 92px;
      height: 92px;
      border-radius: 22px;
      margin: 0 auto 14px;
      background: radial-gradient(circle at 30% 30%, rgba(255,26,26,0.45), rgba(255,26,26,0.10));
      border: 1px solid rgba(255,26,26,0.25);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 40px;
    }
    .rankup-title{
      font-weight: 900;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.95);
      margin: 0 0 6px;
    }
    .rankup-name{
      font-size: 26px;
      font-weight: 900;
      color: var(--red);
      letter-spacing: 1px;
      margin: 0 0 12px;
    }
    .rankup-sub{ color: rgba(255,255,255,0.70); margin: 0 0 14px; }
    .rankup-btn{ width:100%; min-width:unset; height:56px; border-radius:18px; }

    .shake{ animation: shake 0.35s ease; }
    @keyframes shake{
      0%{ transform: translateX(0); }
      20%{ transform: translateX(-10px); }
      40%{ transform: translateX(10px); }
      60%{ transform: translateX(-7px); }
      80%{ transform: translateX(7px); }
      100%{ transform: translateX(0); }
    }

    /* FULLSCREEN MOBILE */
    @media (max-width: 520px){
      #container{ padding:0 !important; height:100dvh; align-items:stretch; }
      .card{
        width:100%;
        min-height:100dvh;
        border-radius:0 !important;
        padding:
          calc(env(safe-area-inset-top) + 16px)
          16px
          calc(env(safe-area-inset-bottom) + 18px)
          16px !important;
        display:flex;
        flex-direction:column;
      }
      #content{ flex:1; overflow:auto; padding-bottom: 86px; -webkit-overflow-scrolling: touch; }
      .btn.play{
        width: 70%;
        max-width: 340px;
        min-width: unset;
        height: 52px;
        font-size: 15px;
        border-radius: 18px;
        align-self:center;
      }
      .btn.check{
        position: sticky;
        bottom: calc(env(safe-area-inset-bottom) + 10px);
        width: 100%;
        min-width: unset;
        height: 58px;
        font-size: 16px;
        border-radius: 18px;
        margin: 14px 0 0;
      }
    }
  </style>
</head>

<body>
  <canvas id="bg"></canvas>
  <div id="streakBox"></div>
  <div id="credit">made by Frihet</div>

  <div id="toast">
    <div id="toastInner" class="toast-inner">
      <span>ðŸ’°</span>
      <span id="toastText">+2 FSD ðŸ’°</span>
    </div>
  </div>

  <div id="rankUpOverlay">
    <div class="rankup-card">
      <div class="rankup-badge">ðŸ’°</div>
      <h3 class="rankup-title">RANK UP</h3>
      <div class="rankup-name" id="rankUpName">Millionaire</div>
      <p class="rankup-sub" id="rankUpSub">Upgrade secured. Keep going.</p>
      <button class="btn rankup-btn" onclick="closeRankUp()">CONTINUE â†’</button>
    </div>
  </div>

  <div id="container">
    <div class="card" id="intro" style="text-align:center;">
      <h1>DISCIPLINE</h1>
      <h2>YOU VS YOU</h2>
      <div class="terminal-line"></div>
      <button class="btn" onclick="startGame()">START SESSION â†’</button>
    </div>
  </div>

<script>
/* ===== Background (candles) ===== */
const canvas = document.getElementById("bg");
const ctx = canvas.getContext("2d");

function resizeCanvas(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

let candles = [];
function initCandles(){
  candles = [];
  for(let i=0;i<40;i++){
    candles.push({
      x: Math.random()*canvas.width,
      y: Math.random()*canvas.height,
      height: Math.random()*60 + 20,
      speed: Math.random()*1 + 0.5
    });
  }
}
initCandles();

function animate(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(const c of candles){
    ctx.fillStyle = "rgba(255,0,0,0.35)";
    ctx.fillRect(c.x, c.y, 6, c.height);
    c.y += c.speed;
    if(c.y > canvas.height) c.y = -c.height;
  }
  requestAnimationFrame(animate);
}
animate();

/* ===== Content (14) ===== */
const items = [
  { en:"I feel you, bro. Iâ€™ve also been through a lot.", de:"Ich fÃ¼hl dich, Bro. Ich hab auch schon viel durchgemacht.", es:"Te entiendo, bro. Yo tambiÃ©n he pasado por mucho." },
  { en:"You donâ€™t need motivation. you just need discipline, bro.", de:"Du brauchst keine Motivation. Du brauchst Disziplin, Bro.", es:"No necesitas motivaciÃ³n. Necesitas disciplina, bro." },
  { en:"You just need to control yourself. itâ€™s you vs you, bro.", de:"Du musst dich einfach kontrollieren. Es geht nur um dich gegen dich, Bro.", es:"Solo tienes que controlarte. Es tÃº contra tÃº, bro." },
  { en:"I want you to succeed, bro. I believe in you.", de:"Ich will, dass du Erfolg hast, Bro. Ich glaub an dich.", es:"Quiero que tengas Ã©xito, bro. Creo en ti." },
  { en:"But you know, someone has to do 9 to 5 stuff. Not everyone can be a millionaire.", de:"Aber weiÃŸt du, irgendwer muss halt den 9-to-5-Job machen. Nicht jeder wird MillionÃ¤r.", es:"Pero ya sabes, alguien tiene que trabajar de 9 a 5. No todos van a ser millonarios." },
  { en:"I know itâ€™s hard but dude nothing is easy in this world. You gotta work hard.", de:"Ich weiÃŸ, es ist hart, aber nichts auf dieser Welt ist leicht. Du musst hart arbeiten.", es:"SÃ© que es difÃ­cil, pero nada en este mundo es fÃ¡cil. Tienes que trabajar duro." },
  { en:"Go ghost, bro. You canâ€™t grow when people are around you.", de:"Zieh dich zurÃ¼ck, Bro. Du kannst nicht wachsen, wenn stÃ¤ndig Leute um dich herum sind.", es:"Desaparece un rato, bro. No puedes crecer si la gente siempre estÃ¡ alrededor." },
  { en:"Lock in. You wanna be rich or not?", de:"Fokussier dich. Willst du reich werden oder nicht?", es:"ConcÃ©ntrate. Â¿Quieres ser rico o no?" },
  { en:"I donâ€™t wanna be an NPC, bro. Thatâ€™s why Iâ€™m working this hard.", de:"Ich will kein NPC sein, Bro. Deshalb arbeite ich so hart.", es:"No quiero ser un NPC, bro. Por eso estoy trabajando asÃ­ de duro." },
  { en:"You think I enjoy going to the gym every day? Hell nah, bro. I genuinely donâ€™t.", de:"Denkst du, ich geh gern jeden Tag ins Gym? Hell nah, Bro. Ehrlich nicht.", es:"Â¿Crees que disfruto ir al gym todos los dÃ­as? Hell nah, bro. De verdad que no." },
  { en:"You live only one life, bro. Nothing can stop you. do what you want.", de:"Du hast nur ein Leben, Bro. Nichts kann dich aufhalten. Mach, was du willst.", es:"Solo tienes una vida, bro. Nada puede detenerte. Haz lo que quieras." },
  { en:"If you want big money, make a big move. You canâ€™t get rich with a 9 to 5 job, you know that.", de:"Wenn du groÃŸes Geld willst, musst du groÃŸe Moves machen. Mit einem 9-to-5-Job wirst du nicht reich, das weiÃŸt du.", es:"Si quieres mucho dinero, haz un gran movimiento. No te vas a hacer rico con un trabajo de 9 a 5, tÃº lo sabes." },
  { en:"If you wanna be different, you gotta be emotionless, bro. Learn to control your emotions", de:"Wenn du anders sein willst, musst du emotionslos sein, Bro. Lern, deine Emotionen zu kontrollieren.", es:"Si quieres ser diferente, tienes que ser frÃ­o, bro. Aprende a controlar tus emociones." },
  { en:"Bro, everyoneâ€™s lost. Itâ€™s not just you. Weâ€™re all lost. Thatâ€™s the beauty of life", de:"Bro, jeder ist verloren. Nicht nur du. Wir sind alle verloren. Das ist das SchÃ¶ne am Leben.", es:"Bro, todos estamos perdidos. No eres solo tÃº. Todos estamos perdidos. Esa es la belleza de la vida." }
];

/* ===== Levels ===== */
const LEVELS = [
  { id:"L1", name:"âœ… Kid",  idx:[0,1,2,10,13] },
  { id:"L2", name:"âš ï¸ Bro",  idx:[3,5,6,7] },
  { id:"L3", name:"ðŸš« King", idx:[4,8,9,11,12] }
];

let activePool = [];   // holds indexes into items
let used = [];
let currentIndex = 0;
let score = 0;
let round = 0;
let selectedChoice = null;
let audio = null;

let nativeLang = localStorage.getItem("nativeLang") || "en";
let selectedMode = localStorage.getItem("mode") || "mix";

/* ===== Persistent FSD ===== */
const TROPHY_KEY = "trophies_forever";
function getFSD(){ return parseInt(localStorage.getItem(TROPHY_KEY) || "0"); }
function setFSD(v){ localStorage.setItem(TROPHY_KEY, String(Math.max(0,v))); }
function addFSD(delta){ const now = getFSD() + delta; setFSD(now); return getFSD(); }

/* Ranks */
const RANKS = [
  { name:"Loser", min:0, max:49 },
  { name:"NPC", min:50, max:149 },
  { name:"Human", min:150, max:299 },
  { name:"Rich", min:300, max:599 },
  { name:"Millionaire", min:600, max:999 },
  { name:"Billionaire", min:1000, max:999999 }
];
function rankFor(v){ return RANKS.find(r=>v>=r.min && v<=r.max) || RANKS[0]; }

/* UI text */
const UI = {
  en:{
    chooseNative:"Choose your native language",
    chooseLevel:"Choose your level",
    chooseMode:"Choose a mode",
    mix:"MIX", listenOnly:"Listen", buildOnly:"Build",
    play:"PLAY", check:"CHECK",
    listenDecide:"Listen & Decide",
    buildFocus:"Build With Focus",
    sessionComplete:"Session Complete",
    score:"Score",
    restart:"Restart",
    strong:"LOCKED.",
    reset:"-1. Refocus."
  },
  de:{
    chooseNative:"WÃ¤hle deine Muttersprache",
    chooseLevel:"WÃ¤hle dein Level",
    chooseMode:"WÃ¤hle den Modus",
    mix:"MIX", listenOnly:"HÃ¶ren", buildOnly:"Bauen",
    play:"PLAY", check:"PRÃœFEN",
    listenDecide:"HÃ¶ren & Entscheiden",
    buildFocus:"Satz bauen",
    sessionComplete:"Session beendet",
    score:"Punktzahl",
    restart:"Neustart",
    strong:"LOCKED.",
    reset:"-1. Fokus."
  },
  es:{
    chooseNative:"Elige tu idioma nativo",
    chooseLevel:"Elige tu nivel",
    chooseMode:"Elige el modo",
    mix:"MIX", listenOnly:"Escuchar", buildOnly:"Construir",
    play:"PLAY", check:"COMPROBAR",
    listenDecide:"Escucha y decide",
    buildFocus:"Construye la frase",
    sessionComplete:"SesiÃ³n terminada",
    score:"PuntuaciÃ³n",
    restart:"Reiniciar",
    strong:"LOCKED.",
    reset:"-1. EnfÃ³cate."
  }
};
function t(k){ return (UI[nativeLang] && UI[nativeLang][k]) || UI.en[k] || k; }
function displayText(i){
  const obj = items[i];
  return obj[nativeLang] || obj.en;
}

/* Streak */
function updateStreak(){
  const today = new Date().toDateString();
  const last = localStorage.getItem("lastDate");
  let streak = parseInt(localStorage.getItem("streak") || "0");
  if(last !== today){
    const y = new Date(); y.setDate(y.getDate()-1);
    streak = (last === y.toDateString()) ? (streak+1) : 1;
    localStorage.setItem("streak", String(streak));
    localStorage.setItem("lastDate", today);
  }
  document.getElementById("streakBox").innerText = "ðŸ”¥ Streak: " + (localStorage.getItem("streak") || "1");
}
updateStreak();

/* ===== Screens ===== */
function startGame(){
  document.getElementById("container").innerHTML = `
    <div class="card" style="text-align:center;">
      <h2 style="margin-top:0;">${t("chooseNative")}</h2>
      <div style="margin-top:18px;">
        <button class="btn" onclick="chooseLang('en')">ðŸ‡¬ðŸ‡§ English</button>
        <button class="btn" onclick="chooseLang('de')">ðŸ‡©ðŸ‡ª Deutsch</button>
        <button class="btn" onclick="chooseLang('es')">ðŸ‡ªðŸ‡¸ EspaÃ±ol</button>
      </div>
    </div>
  `;
}

function chooseLang(lang){
  nativeLang = lang;
  localStorage.setItem("nativeLang", lang);

  const levelButtons = LEVELS.map(lv =>
    `<button class="btn" onclick="startLevel('${lv.id}')">${lv.name}</button>`
  ).join("");

  document.getElementById("container").innerHTML = `
    <div class="card" style="text-align:center;">
      <h2 style="margin-top:0;">${t("chooseLevel")}</h2>
      <p style="color:rgba(255,255,255,0.65); margin-top:8px;">Harder level = harder English.</p>
      <div style="margin-top:16px; display:flex; flex-direction:column; gap:10px; align-items:center;">
        ${levelButtons}
      </div>
    </div>
  `;
}

function startLevel(levelId){
  const lv = LEVELS.find(x=>x.id===levelId);
  activePool = lv.idx.slice();        // indexes into items

  // reset session
  used = [];
  score = 0;
  round = 0;
  selectedChoice = null;
  stopAudio();

  showModeSelect();
}

function showModeSelect(){
  document.getElementById("container").innerHTML = `
    <div class="card" style="text-align:center;">
      <h2 style="margin-top:0;">${t("chooseMode")}</h2>
      <div style="margin-top:16px;">
        <button class="btn" onclick="setMode('mix')">${t("mix")}</button>
        <button class="btn" onclick="setMode('listen')">${t("listenOnly")}</button>
        <button class="btn" onclick="setMode('drag')">${t("buildOnly")}</button>
      </div>
    </div>
  `;
}

function setMode(m){
  selectedMode = m;
  localStorage.setItem("mode", m);
  startSession();
}

function startSession(){
  document.getElementById("container").innerHTML = `
    <div class="card" id="gameCard">
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start; margin-bottom:10px;">
        <div style="color:rgba(255,255,255,0.65); font-weight:700;">
          Round: <span id="roundText">0</span> / <span id="totalText">${activePool.length}</span>
        </div>
        <div style="color:rgba(255,255,255,0.65); text-align:right; font-weight:700;">
          ðŸ’° FSD: <span id="fsdText">${getFSD()}</span><br>
          Rank: <span id="rankText">${rankFor(getFSD()).name}</span>
        </div>
      </div>

      <h2 id="mode"></h2>
      <button class="btn play" onclick="playAudio()">${t("play")}</button>

      <div id="content"></div>
      <div id="result"></div>
    </div>
  `;
  nextRound();
  updateHUD();
}

/* ===== HUD ===== */
function updateHUD(){
  const fsd = getFSD();
  const roundText = document.getElementById("roundText");
  const fsdText = document.getElementById("fsdText");
  const rankText = document.getElementById("rankText");
  if(roundText) roundText.textContent = String(used.length);
  if(fsdText) fsdText.textContent = String(fsd);
  if(rankText) rankText.textContent = rankFor(fsd).name;
}

/* ===== Core helpers ===== */
function normalize(s){
  return s.toLowerCase().replace(/[.,!?]/g,"").replace(/\s+/g,"").trim();
}
function pickNewIndex(){
  let idx;
  do{
    idx = activePool[Math.floor(Math.random()*activePool.length)];
  }while(used.includes(idx));
  return idx;
}

/* ===== Rounds ===== */
function nextRound(){
  if(used.length >= activePool.length){
    document.getElementById("content").innerHTML = `
      <h2>${t("sessionComplete")}</h2>
      <p>${t("score")}: ${score} / ${activePool.length}</p>
      <p>ðŸ’° FSD: ${getFSD()} (Rank: ${rankFor(getFSD()).name})</p>
      <button class="btn" onclick="location.reload()">${t("restart")}</button>
    `;
    document.getElementById("mode").textContent = "";
    document.getElementById("result").textContent = "";
    return;
  }

  selectedChoice = null;
  document.getElementById("result").textContent = "";
  document.getElementById("content").innerHTML = "";

  currentIndex = pickNewIndex();
  used.push(currentIndex);

  updateHUD();

  if(selectedMode === "listen") buildListen();
  else if(selectedMode === "drag") buildDrag();
  else (Math.random()>0.5 ? buildListen() : buildDrag());
}

/* ===== Listen & Decide ===== */
function buildListen(){
  document.getElementById("mode").textContent = t("listenDecide");

  const correctText = displayText(currentIndex);

  // option indexes should come from activePool
  const optionIndexes = [currentIndex];
  while(optionIndexes.length < 4){
    const r = activePool[Math.floor(Math.random()*activePool.length)];
    if(!optionIndexes.includes(r)) optionIndexes.push(r);
  }
  optionIndexes.sort(()=>0.5 - Math.random());

  for(const idx of optionIndexes){
    const div = document.createElement("div");
    div.className = "choice";
    div.textContent = displayText(idx);
    div.onclick = () => {
      document.querySelectorAll(".choice").forEach(c=>c.classList.remove("selected"));
      div.classList.add("selected");
      selectedChoice = displayText(idx);
    };
    document.getElementById("content").appendChild(div);
  }

  const btn = document.createElement("button");
  btn.className = "btn check";
  btn.textContent = t("check");
  btn.onclick = () => {
    if(!selectedChoice) return;
    if(normalize(selectedChoice) === normalize(correctText)) success();
    else fail();
  };
  document.getElementById("content").appendChild(btn);

  if(nativeLang !== "en"){
    const hint = document.createElement("div");
    hint.className = "hint";
    hint.textContent = "English: " + items[currentIndex].en;
    document.getElementById("content").appendChild(hint);
  }
}

/* ===== Build With Focus ===== */
function buildDrag(){
  document.getElementById("mode").textContent = t("buildFocus");

  const targetSentence = displayText(currentIndex);
  const words = targetSentence.split(" ");
  const shuffled = [...words].sort(()=>0.5 - Math.random());

  const top = document.createElement("div");
  top.className = "word-container";
  top.id = "top";

  const bottom = document.createElement("div");
  bottom.className = "word-container";
  bottom.id = "bottom";

  for(const w of shuffled){
    const chip = document.createElement("div");
    chip.className = "word";
    chip.textContent = w;
    chip.onclick = () => {
      if(chip.parentElement.id === "bottom") top.appendChild(chip);
      else bottom.appendChild(chip);
    };
    bottom.appendChild(chip);
  }

  const btn = document.createElement("button");
  btn.className = "btn check";
  btn.textContent = t("check");
  btn.onclick = () => {
    let built = "";
    document.querySelectorAll("#top .word").forEach(w=> built += w.textContent + " ");
    if(normalize(built) === normalize(targetSentence)) success();
    else fail();
  };

  document.getElementById("content").appendChild(top);
  document.getElementById("content").appendChild(bottom);
  document.getElementById("content").appendChild(btn);

  if(nativeLang !== "en"){
    const hint = document.createElement("div");
    hint.className = "hint";
    hint.textContent = "English: " + items[currentIndex].en;
    document.getElementById("content").appendChild(hint);
  }
}

/* ===== Feedback ===== */
function showToast(delta){
  const toast = document.getElementById("toast");
  const inner = document.getElementById("toastInner");
  const text = document.getElementById("toastText");

  toast.classList.remove("toast-show");
  inner.classList.remove("good","bad");

  if(delta > 0){
    inner.classList.add("good");
    text.textContent = `+${delta} FSD ðŸ’°`;
  }else{
    inner.classList.add("bad");
    text.textContent = `${delta} FSD ðŸ’°`;
  }

  void toast.offsetWidth;
  toast.classList.add("toast-show");
}

function shakeCard(){
  const card = document.getElementById("gameCard");
  if(!card) return;
  card.classList.remove("shake");
  void card.offsetWidth;
  card.classList.add("shake");
}

let pendingNext = null;
function showRankUp(newRankName){
  document.getElementById("rankUpName").textContent = newRankName;
  document.getElementById("rankUpOverlay").style.display = "flex";
}
function closeRankUp(){
  document.getElementById("rankUpOverlay").style.display = "none";
  if(typeof pendingNext === "function"){
    const fn = pendingNext; pendingNext = null; fn();
  }
}

/* Correct: +2 FSD, Wrong: -1 FSD */
function success(){
  playSound(true);
  score++;

  const beforeRank = rankFor(getFSD()).name;
  addFSD(+2);
  showToast(+2);
  const afterRank = rankFor(getFSD()).name;

  updateHUD();
  document.getElementById("result").textContent = t("strong");
  stopAudio();

  if(afterRank !== beforeRank){
    pendingNext = () => setTimeout(nextRound, 250);
    showRankUp(afterRank);
    return;
  }
  setTimeout(nextRound, 900);
}

function fail(){
  playSound(false);

  addFSD(-1);
  showToast(-1);
  shakeCard();

  updateHUD();
  document.getElementById("result").textContent = t("reset");
  stopAudio();

  setTimeout(nextRound, 1100);
}

function playAudio(){
  stopAudio();
  // audio files must match the item order: audio1..audio14
  audio = new Audio(`audio${currentIndex + 1}.mp3`);
  audio.play().catch(()=>{ /* ignore autoplay errors */ });
}
function stopAudio(){
  if(audio){ audio.pause(); audio.currentTime = 0; }
}

/* Soft click sound */
function playSound(success){
  const aCtx = new (window.AudioContext||window.webkitAudioContext)();
  const osc = aCtx.createOscillator();
  const gain = aCtx.createGain();
  osc.connect(gain);
  gain.connect(aCtx.destination);
  osc.frequency.value = success ? 600 : 220;
  gain.gain.value = 0.05;
  osc.start();
  setTimeout(()=>osc.stop(), 90);
}
</script>
</body>
</html>





